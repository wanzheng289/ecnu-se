## 11.1 大容量存储结构概述
现代计算机的大部分辅助存储设备是硬盘驱动器HDD和非易失性存储器NVM
### 11.1.1 硬盘驱动器HDD
更适合顺序读取数据
1.原理：硬盘通过旋转带有磁性涂层的盘片，并配合可移动的读写磁头来进行数据访问
2.硬盘的盘片旋转速度为每秒60到250转
3.传输速率：硬盘与计算机之间传输数据的速度
- 理论最大传输速率=6Gb/s
- 实际有效传输速率=1Gb/s
4.时间：
- 定位时间/随机访问时间
	- 寻道时间：移动磁头到目标磁道的时间
		- 3ms-12ms，桌面硬盘常见为9ms左右
		- 通常按1/3轨道的平均距离来估算
	- 旋转延迟：等待目标扇区旋转到磁头下方的时间
		- 由盘片的转速决定：单圈旋转时间=60/RPM
		- e.g.7200RPM→单圈旋转时间=60/7200=8.33ms
		- 平均旋转延迟=半圈旋转时间=1/2单圈时间
- 数据传输时间
5.磁头划碰：磁头与盘片接触，会严重损坏数据
6.磁盘可以是可拆卸的
7.磁盘性能
①$访问延迟=平均访问时间=平均寻道时间+平均旋转延迟$
②$平均输入输出时间=平均访问时间+\frac{数据传输量}{传输速率}+控制器开销$
e.g.传输一个4KB数据块，磁盘转速7200RPM，平均寻道时间5ms，传输速率1Gb/s，控制器开销0.1ms

$平均旋转延迟=\frac{1}{2}*\frac{60}{7200}=4.17ms$
$数据传输时间=\frac{4KB}{1Gb/s}=\frac{4*2^{10}B}{\frac{1}{8}GB/s}=\frac{2^{12}B}{\frac{1}{8}*2^{30}B/s}=2^{-15}s\approx0.031ms$
$平均I/O时间=平均寻道时间+平均旋转时间+数据传输时间+控制器开销=5ms+4.17ms+0.031ms+0.1ms=9.301ms$
### 11.1.2 非易失性存储设备NVM
如果形态类似传统硬盘，这类非易失性存储设备被称为固态硬盘SSD,SSD是最常见的NVM类型，用于替代传统机械硬盘
更可靠，更快，消耗功率小，没有机械部件，因此不存在寻道时间或旋转延迟；贵，容量小

| 属性      | HDD        | SSD / NVM           |
| ------- | ---------- | ------------------- |
| 是否机械    | 有（磁头+盘片）   | 无（电子器件）             |
| 寻道 & 延迟 | 有          | 无                   |
| 速度      | 慢（机械限制）    | 快（电子级别）             |
| 价格（每MB） | 便宜         | 贵                   |
| 容量      | 大（可达数十 TB） | 相对较小                |
| 可靠性     | 易受损（震动、老化） | 更耐震但存在闪存寿命限制        |
| 接口      | SATA, SAS  | SATA, PCIe（NVMe 更快） |
#### 非易失性存储设备概述
固态磁盘SSD：先擦后写
- 数据是以页为单位进行读取和写入的，但不能原地覆盖写入
- 写入前必须先擦除，而擦除是以更大的块为单位进行的
- 写入磨损：每个存储单元只能被擦除有限次数，超过后会失效
- NAND-NVM寿命以每天的驱动器写入次数DWPD衡量
#### NAND闪存控制器算法
由于不能原地覆盖写入，页面最终会混合有效数据和无效数据
- 控制器维护一个闪存转换层FTL：将逻辑地址映射到物理地址+追踪哪些逻辑块是有效的
- 垃圾收集-回收无效页空间：将剩余有效页复制到新块，整块擦除回收后原块，释放空间供新数据写入
- 超额配置：留出一些页面作为始终可写入的区域，有助于平衡磨损
- 由于每个单元都有寿命，所以需要磨损均衡来平均写入每个单元
### 11.1.3 易失性存储器
1.内存DRAM常用于大容量存储用途
虽然DRAM严格意义上不是辅助存储（因为它断电后会丢失数据），但它可以被格式化为文件系统，用作一种非常快的辅助存储替代方案。
2.虚拟内存盘RAM drives：在系统中表现为原始块设备，通常格式化为文件系统
- 系统的缓存由程序员、操作系统或硬件自动管理，用户通常无法直接干预
- RAM盘是用户可以手动创建和管理的
### 11.1.4 二级存储连接方法
1.主机连接的存储设备通过I/O端口连接到I/O总线
最常见：SATA串行接口
SSD等非易失性存储通过NVMe接口直接连接PCIe总线
2.数据在总线上传输需由控制器完成，也称为主机总线适配器HBA
- 主控制器：在计算机端，负责发出命令
- 设备控制器：在磁盘端，执行命令，完成数据收发
计算机通过内存映射I/O端口向主控制器发送命令
传输过程：
- 控制器将指令发送给磁盘端
- 数据使用DMA在设备和主机内存之间直接传输
### 11.1.5 地址映射
1.逻辑块
- 硬盘通过一维的逻辑块数组进行寻址，每个逻辑块是最小的数据传输单位
- 低级格式化会在物理磁盘上划分出这些逻辑块
2.逻辑块映射到物理磁盘
这些逻辑块顺序地映射到磁盘上的扇区，扇区0是最外层柱面的第一条磁道上的第一个扇区
映射顺序：
- 当前磁道剩下的所有扇区
- 当前柱面中其它磁道
- 向内移动到下一个柱面，再重复以上过程
## 11.2 HDD调度
操作系统会为每个磁盘或设备维护一个请求队列
- 若磁盘空闲，请求可立刻执行
- 若磁盘正忙，新请求需要排队等待
磁盘队列的I/O请求块的柱面的队列：`98,183,37,122,14,124,65,67`
磁头开始位于柱面53
### 11.2.1 FCFS调度
$总移动距离=\sum每次移动的距离$
移动顺序：53-98-183-37-122-14-124-65-67
磁头移动柱面的总数=640
### 11.2.2 SCAN调度/电梯算法
磁盘磁臂从磁盘的一端出发，朝一个方向移动，沿路处理遇到的所有请求，直到到达另一端，然后反向移动并继续处理
需要确定磁头的当前位置+移动方向
【走到头再掉头】
e.g.朝0移动，初始53：53-37-14-<font color="#c00000">走到0</font>-65-67-98-122-124-183
### 11.2.3 C-SCAN调度
到达另一端后立即返回磁盘开头
【走到头再回到另一端的开头】
e.g.朝199移动，初始53：65-67-98-122-124-183-<font color="#c00000">199-回到0</font>-14-37
### 11.2.4 磁盘调度算法的选择
1.SCAN和C-SCAN更适合磁盘负载较高的系统
- 优点：比FCFS 更少出现饥饿现象
- 缺点：饥饿仍然有可能发生，尤其是当某些请求总被跳过的时候
2.Linux的deadline调度器设计
①读写分离，读优先
- 读请求和写请求维护单独的队列
- 因为进程更可能会因为读不到数据而阻塞，所以系统会优先处理读请求
②总共实现了4个队列（2读2写）
- 一个读队列和一个写队列按LBA顺序排列（逻辑块地址）
- 另一个读队列和写队列按FCFS顺序排列
每次处理时从这些队列中按某个队列的顺序打包一批I/O请求进行处理，然后检查FCFS队列中是否存在超过指定时限的请求，如果存在，则下一批优先从该请求所在的LBA队列中选择请求处理，避免饿死
## 11.3 NVM调度
在RHEL7中使用NOOP调度器，不进行复杂排序，只做简单的合并处理
问题：写放大效应
- 想修改一个字节，实际上可能要触发垃圾回收，从而导致大量读写操作，甚至擦除整个块
- 降低性能，增加设备磨损
## 11.4 错误检测和纠正
#### 错误检测
奇偶校验位
校验和
循环冗余校验CRC
#### 错误纠正
纠错码ECC
## 11.5 存储设备管理
### 11.5.1 驱动器格式化、分区与卷
1.低级格式化/物理格式化：将磁盘划分为扇区，使磁盘控制器能够对其进行读写操作
每个扇区可以包含头部信息、数据本体、纠错码
每个扇区通常能存储512字节的数据
2.使用磁盘存文件时，操作系统还需记录其自身结构
操作系统先将磁盘分区，每个分区都被当作一个逻辑磁盘使用
3.逻辑格式化/创建文件系统：用于管理文件和目录结构
4.为提升效率，文件系统常把块组成簇
### 11.5.2 引导块
引导块用于在开机时初始化系统
- 启动引导程序存储在主板的ROM或固件中
- 引导加载器程序存储在磁盘的引导块中，属于启动分区
### 11.5.3 坏块
使用扇区备用的方法处理磁盘中的坏块
#### 交换空间管理
当DRAM不足以容纳所有进程时，操作系统会将整个进程或部分页面移动到外部存储设备，操作系统负责管理交换空间
- 外部存储（如硬盘）比内存慢得多，因此性能优化非常关键，最好使用专门的设备来配置交换空间，性能更好
- 通常可以设置多个交换空间，以减少对单一设备的 I/O 压力
- 交换空间既可以是裸分区，也可以是文件系统中的一个普通文件
## 11.7 存储链接
### 11.7.1 主机连接存储
主机直连通过本地I/O接口访问存储设备，使用多种不同的技术
- 要连接多个设备时，常使用存储总线技术
- 高端系统采用光纤通道作为存储连接技术
### 11.7.2 网络连接存储NAS
通过网络提供的存储资源
常用协议：NFS和CIFS
实现机制：远程过程调用-主机与存储之间通过网络通信，使用TCP或UDP协议，通过RPC实现数据访问
`NAS-LAN/WAN-client`
iSCSI协议是另一种网络存储方式，它是通过IP网络传输SCSI协议，实现块设备的远程访问
### 11.7.3 云存储
- 能跨网络访问存储设备
- 通过互联网或广域网连接到远程的数据中心，而不是仅限于局域网
- 访问方式
	- NAS被呈现为一个普通的文件系统，操作系统可以直接挂载它
	- 云存储是API驱动的服务，程序必须调用特定的API（应用程序接口）来进行访问
		- 使用API可以更好地控制访问、实现断点续传、错误重试等机制

### 11.7.4 存储区域网络与存储阵列
#### 存储阵列
- 可以连接单个磁盘或多个磁盘组成的阵列
- 不像NAS那样依赖网络传输数据，因此不会占用网络带宽，避免了NAS在高流量场景下可能出现的性能瓶颈
- 具有控制器并提供多种功能支持主机访问
	- 端口：提供接口将主机与存储阵列连接起来
	- 控制器组件：包含内存、控制软件（可能包括非易失性内存如 NVRAM）来管理磁盘和数据访问
	- 容量灵活：存储阵列可小至几个磁盘，也可扩展至数千个磁盘，具备很强的扩展性
	- 数据保护功能
		- RAID（冗余磁盘阵列）提升性能和容错能力
		- 热备盘：备用盘在主盘损坏时自动接管
		- 热插拔：磁盘损坏可在系统运行时替换，不需关机
	- 支持共享存储：多个主机可以共享一套存储阵列资源，从而提高资源利用率和效率
	- 内置类似文件系统的高级功能
		- 快照：保存某一时刻的数据状态，便于回滚恢复
		- 克隆：创建数据副本
		- 精简配置：按需分配存储，节省空间
		- 复制：数据副本复制到另一个地点以提升可靠性
		- 去重：消除重复数据，节省空间
#### 存储区域网络
- 常见于大型存储环境中
- 多个主机连接到多个存储阵列，提供灵活的资源分配和访问方式
## 11.8 RAID结构
定义：廉价磁盘冗余阵列，通过多个磁盘组成一组，共同提供数据冗余和可靠性
### 11.8.1 通过冗余提高可靠性
可靠性指标
- 平均故障间隔时间：指一个磁盘在正常工作条件下发生故障的平均时间，RAID 通过冗余延长整个系统的平均故障间隔时间
- 平均修复时间：一个磁盘故障后被修复（或替换）的平均耗时
	- 修复期间是暴露期
- 平均数据丢失时间：用于估计出现数据永久丢失的平均时间
各类RAID利用冗余数据提高系统性能与可靠性
### 11.8.2 通过并行处理提高性能
磁盘条带化是将多个磁盘组合成一个逻辑存储单元。数据被分割成多个条带，按顺序写入不同磁盘，从而并行提高性能
### 11.8.3 RAID级别
- RAID 1：镜像/影子机制：每个磁盘都有一个完整的副本，若一块盘坏了，另一块能立即接管，可靠性高，读性能也提升，但成本较高，存储效率仅50%
- RAID 1+0/RAID 0+1：镜像+条带化
	- RAID 1+0：先镜像后条带：先把每块数据镜像备份，再做条带化→读写性能好，可靠性也高
	- RAID 0+1先条带后镜像：先条带化再整体镜像→容错性稍低于RAID 1+0
- RAID 4 5 6：利用奇偶校验位进行容错，不需要复制整块磁盘，冗余开销小，空间利用率高
	- RAID 4：专用一块盘记录奇偶校验位，写入容易成为瓶颈；
	- RAID 5：奇偶校验位分散在所有磁盘中，解决瓶颈，性价比高；  
	- RAID 6：使用两个独立的奇偶校验位块，允许两个磁盘同时故障，可靠性更高。
跨阵列复制：即使一个 RAID 阵列内部防止了磁盘故障，如果整个阵列控制器/存储单元损坏，仍会造成数据丢失。因此系统间会使用复制机制将数据同步到其他阵列中
热备盘：一些系统会设置热备盘：这些磁盘通常闲置，一旦有磁盘故障，它们会自动顶上并触发数据自动重建，从而减少系统宕机时间
#### 改进：Solaris ZFS
- 问题：RAID 本身只能应对磁盘损坏，但无法防止或检测数据本身的损坏或其他错误
- 改进
	- Solaris ZFS 会为所有数据和元数据都计算校验和
	- ZFS 取消了传统的分区和卷概念，所有磁盘被加入一个共享的存储池中，文件系统不是直接对磁盘操作，而是从池中动态申请和释放空间
### 11.8.7 对象存储
先构建一个存储池，再往里放对象
- 对象只是数据的一个容器
- 无法通过目录等方式浏览存储池中的对象（没有目录结构，服务功能少）
- 更偏向计算机友好，而非用户友好
- 使用流程：
	- 在存储池中创建对象，得到一个对象ID
	- 通过对象ID访问对象
	- 通过对象ID删除对象
- 通常是通过在 N 台系统中存储 N 份副本来实现冗余保护
- 水平可扩展：只要增加机器节点，系统容量和性能就可以线性增长
- 基于内容寻址、非结构化数据

#### Quiz
0-199，当前50.方向小→大
队列：`35,80,150,10,180,70`
1.FCFS
50-35：15
35-80：45
80-150：70
150-10：140
10-180：170
180-70：110
共550

2.SCAN
~~50-70-80-150-180-0-10-35~
~~20+10+70+30+180+10+25=345~~
【正确】50-70-80-150-180-<font color="#c00000">199</font>-35-10
20+10+70+30+19+164+25=338
<font color="#c00000">【走到头】</font>