# 5.1 
<font color="#76923c">请列举三个在建立连接时可能需要协商的协议参数示例。</font>
1.窗口大小：用于控制发送方的流量，在接收方发送ack之前可发送的数据数量
2.最大报文长度：能够接收的最大数据长度，超过该长度需要先分片再传输，如果不能分片则丢弃该数据包
3.seq：双方的序列号，用于区分新旧数据包
【谈判可以设置窗口大小、最大数据包大小、数据速率和计时器值。】
# 5.2
<font color="#76923c">考虑图 5-12(a) 所示的网络。当前使用的是距离矢量路由算法，路由器D刚刚收到了如下链路状态分组：</font>
<font color="#76923c">- 来自A：(B: 5, E: 4)</font>
<font color="#76923c">- 来自B：(A: 4, C: 1, F: 5)</font>
<font color="#76923c">- 来自C：(B: 3, D: 4, E: 3)</font>
<font color="#76923c">- 来自E：(A: 2, C: 2, F: 2)</font>
<font color="#76923c">- 来自F：(B: 1, D: 2, E: 3)</font>
<font color="#76923c">已知从D到C的链路开销为3，从D到F的链路开销为4。</font>
<font color="#76923c">问：D 新的路由表是什么？请给出到达每个目的节点所使用的输出线路以及相应的开销。</font>
![[Pasted image 20251223155645.png]]
初始：

|     | A   | B   | C   | D   | E   | F   |
| --- | --- | --- | --- | --- | --- | --- |
| A   | 0   | 4   |     |     | 2   |     |
| B   | 5   | 0   | 3   |     |     | 1   |
| C   |     | 1   | 0   | 3   | 2   |     |
| D   |     |     | 4   | 0   |     | 2   |
| E   | 4   |     | 3   |     | 0   | 3   |
| F   |     | 5   |     | 4   | 2   | 0   |
更新：

|     | A   | B   | C   | D   | E   | F   |
| --- | --- | --- | --- | --- | --- | --- |
| A   | 0   | 4   |     |     | 2   |     |
| B   | 5   | 0   | 3   | 5   |     | 1   |
| C   |     | 1   | 0   | 3   | 2   |     |
| D   |     |     | 4   | 0   |     | 2   |
| E   | 4   |     | 3   | 6   | 0   | 3   |
| F   |     | 5   |     | 4   | 2   | 0   |
D-A：∞【8】
D-B：D-F-B，花销5
D-C：直连，花销3
D-D：花销0
D-E：D-C-E：花销6
D-F：直连，花销4
【从D计算到每个目的地的最短路径得到成本（8，5，3，0，6，4）。出行的线路是（C，F，C，-，C，F）。】
# 5.3
<font color="#76923c">如果在一个拥有50个路由器的网络中，路径开销以8位数字记录，且各路由器每秒交换两次距离矢量，请问该分布式路由算法在每条（全双工）链路上消耗了多少带宽？假设每个路由器都有三条连接到其他路由器的链路。</font>
每个路由器的路由表有49项
一共$49*8*2*2=1568bps$
【路由表是400位。每秒两次将此表写入每行，因此每个方向每行需要800 bps。】
# 5.4
<font color="#76923c">假设主机A连接到路由器R1，R1连接到另一个路由器R2，R2连接到主机B。假设一个包含900字节数据和20字节TCP头的TCP消息被传递到主机A的IP层以发送到B。 </font>
<font color="#76923c">显示在三个链路上传输的每个数据包的IP头中的总长度、标识、DF、MF和分片偏移字段。</font>
<font color="#76923c">假设链路A-R1可以支持最大帧大小为1024字节，包括14字节的帧头</font>
<font color="#76923c">链路R1-R2可以支持最大帧大小为512字节，包括8字节的帧头</font>
<font color="#76923c">链路R2-B可以支持最大帧大小为512字节，包括12字节的帧头</font>
<font color="#c00000">【一些解释】</font>
<font color="#c00000">1.TCP header是IP payload的一部分</font>
<font color="#c00000">2.total length</font>
<font color="#c00000">=IP header+IP payload</font>
<font color="#c00000">=IP header+TCP header+TCP data</font>
<font color="#c00000">3.MTU</font>
<font color="#c00000">=frame header+最大可以传输的IP报文</font>
<font color="#c00000">=frame header+IP header+IP payload</font>
<font color="#c00000">所以要将【IP header+IP payload】的值与【MTU-frame header】的值对比</font>
<font color="#c00000">4.关于【8】</font>
<font color="#c00000">①计算每个分片的payload：需要将【MTU-frame header-IP header】的值向下取整为8的倍数</font>
<font color="#c00000">②计算分片数量：用IP payload【=total length-IP header（20bytes）】去除这个8的倍数值</font>
<font color="#c00000">③计算段偏移量：用当前位置【=当前片之前的所有片的payload之和】除以8</font>
<font color="#c00000">5.每个分片的length=IP header+每个分片的payload</font>
`A-R1-R2-B`
数据：900bytes
TCP头部：20bytes
IP头部：20bytes
1.`A-R1`
MTU=1024bytes=14+1010
最大帧长度=1010bytes
$\because 940 \lt 1010$
$\therefore 不用分片$

|     | 总长度      | 标识  | DF  | MF  | Fragment offset |
| --- | -------- | --- | --- | --- | --------------- |
| 1   | 940bytes | 1   | 0   | 0   | 0               |


2.`R1-R2`
MTU=512bytes=8+504
最大帧长度=504bytes
最大数据=504-20=484bytes
取8的倍数480bytes
$\therefore 分成2个包$
①分片1：
总长度=480+20=500bytes
②分片2：
数据=920-480=440bytes
总长度=440+20=460bytes
偏移=480/8=60

|     | 总长度      | 标识  | DF   | MF  | Fragment offset |
| --- | -------- | --- | ---- | --- | --------------- |
| 1   | 500bytes | 1   | 1【0】 | 1   | 0               |
| 2   | 460bytes | 1   | 1【0】 | 0   | 60              |

3.`R2-B`
MTU=512bytes=12+500
最大帧长度=500bytes
$\because 500 \leq 500,460 \leq 500$
$\therefore 不再分片$

|     | 总长度      | 标识  | DF   | MF  | Fragment offset |
| --- | -------- | --- | ---- | --- | --------------- |
| 1   | 500bytes | 1   | 1【0】 | 1   | 0               |
| 2   | 460bytes | 1   | 1【0】 | 0   | 60              |
<font color="#c00000">DF = 1：不允许路由器对该包进行分片，如果不能传输，直接丢弃并发送 ICMP。</font>
<font color="#c00000">DF = 0：允许路由器对该包进行分片。</font>
# 5.5
<font color="#76923c">一个路由器正在持续高速发送 IP 数据报，每个数据报的总长度（数据部分加上首部）为 1024 字节。假设数据报在网络中的存活时间为 10 秒，请问该路由器在不产生“标识符空间回绕”风险的前提下，能够运行的最大链路速度是多少？</font>
标识16bits
共$2^{16}$个id
$v=\frac{2^{16}*1024*8}{10}=\frac{2^{16}*2^{10}*2^{3}}{10}=\frac{2^{29}}{10}=1.6*2^{25}bps$

【如果线路的比特率是b，路由器每秒可以发射的包数是b/8192，因此发射一个包所需的时间是8192/b =$\frac{2^{13}}{b}$ 。

发射65,536个包（Identification字段共16位）需要$\frac{2^{29}}{b}$秒。将其等于最大包生存时间，我们得到$\frac{2^{29}}{b}$= 10。那么，b大约是54 Mbps。
】
# 5.6
<font color="#76923c">一个使用了严格源路由选项的IP数据报需要进行分片。你认为该选项应该被复制到每一个分片中，还是只需要放在第一个分片中即可？请解释你的理由。</font>
我认为该选项应该被复制到每个分片中，因为每个分片是独立的，可能通过不同路径传输，如果该选项只被放在第一个分片中，那么其他分片可能会按照其他路径进行传输，不满足严格源路由选项的要求。
【这些信息是必要的，以便为每个片段进行路由，因此它必须在所有片段中都出现。】
# 5.7
<font color="#76923c">假设B类地址的网络部分最初不是使用16位，而是使用了20位。那么在这种情况下总共会有多少个B类网络？</font>
B类地址以`10`开头，固定2位
$20-2=18$
$N=2^{18}$
【使用2位前缀，网络将剩余18位。因此，网络的数量将是2的18次方，即262,144个。<font color="#c00000">然而，所有0和所有1都是特殊的，所以只有262,142个是可用的。</font>】
# 5.8
<font color="#76923c">从198.16.0.0开始有大量连续的IP地址可用。假设有四个组织A、B、C 和 D，它们按此顺序分别申请4000、2000、4000和8000个地址。对于每一个组织，请给出分配给它的起始IP地址、结束IP地址，以及采用w.x.y.z/s记法表示的掩码。</font>
A：
分配$4096=2^{12}$个地址，后缀=12，前缀=32-12=20
20落在第3个字节，$2^{12}/256=16$
起始IP地址：`198.16.0.0/20`
结束IP地址：`198.16.15.255/20`

B：
分配$2048=2^{11}$个地址，后缀=11，前缀=32-11=21
21落在第3个字节，$2^{11}/256=8$
第3个字节对齐：16
起始IP地址：`198.16.16.0/21`
结束IP地址：`198.16.23.255/21`

C：
分配$4096=2^{12}$个地址，后缀=12，前缀=32-12=20
20落在第3个字节，$2^{12}/256=16$
第3个字节对齐：32
起始IP地址：`198.16.32.0/20`
结束IP地址：`198.16.47.255/20`

D：
分配$8192=2^{13}$个地址，后缀=13，前缀=32-13=19
19落在第3个字节，$2^{13}/256=32$
第3个字节对齐：64
起始IP地址：`198.16.64.0/19`
结束IP地址：`198.16.95.255/19`
# 5.9
<font color="#76923c">一个路由器在其路由表中拥有如下（CIDR）表项：</font>
![[Pasted image 20251223170756.png]]
<font color="#76923c">对于下列每一个 IP 地址，如果一个带有该地址的分组（数据包）到达，路由器会如何处理？</font>
<font color="#76923c">(a) 135.46.63.10 </font>
<font color="#76923c">(b) 135.46.57.14 </font>
<font color="#76923c">(c) 135.46.52.2 </font>
<font color="#76923c">(d) 192.53.40.7 </font>
<font color="#76923c">(e) 192.53.56.7</font>
1.`135.46.56.0/22`
前缀=22，后缀=32-22=10，地址数量$2^{10}$
22落在第3个字节，$2^{10}/256=4$
起始IP地址：`135.46.56.0/22`
结束IP地址：`135.46.59.255/22`

2.`135.46.60.0/22`
前缀=22，后缀=32-22=10，地址数量$2^{10}$
22落在第3个字节，$2^{10}/256=4$
起始IP地址：`135.46.60.0/22`
结束IP地址：`135.46.63.255/22`

3.`192.53.40.0/23`
前缀=23，后缀=32-23=9，地址数量$2^{9}$
23落在第3个字节，$2^{9}/256=2$
起始IP地址：`192.53.40.0/23`
结束IP地址：`192.53.41.255/23`

a：`135.46.63.10`落在`135.46.60.0/22`-`135.46.63.255/22`，路由器将其转发至Interface 1
b：`135.46.57.14`落在`135.46.56.0/22`-`135.46.59.255/22`，路由器将其转发至Interface 0
c：`135.46.52.2`不属于任何范围，路由器将其转发至Router 2
d：`192.53.40.7`落在`192.53.40.0/23`-`192.53.41.255/23`，路由器将其转发至Router 1
e：`192.53.56.7`不属于任何范围，路由器将其转发至Router 2
# 5.10
<font color="#76923c">同一网络中的两台机器尝试使用相同的端口号与另一个网络上的服务器通信。这是否可行？请说明理由（无论可行与否）。如果这两台机器是通过 NAT 设备（网络地址转换器）与外部网络隔离的，情况会发生什么变化？</font>
1.同一网络中的两台机器可以使用相同的端口号与另一个网络上的服务器通信，因为它们的IP地址不同
2.通过NAT与外部网络隔离的同一网络中的两台机器不可以使用相同的端口号与另一个网络上的服务器通信，因为发出时，NAT只能将多个IP映射成一个公共IP，而不能修改端口号。如果使用NAPT，可以将该端口号映射到两个不同的端口号中，回传时按照映射表修改回原端口号

【这是可能的，因为机器的IP地址是不同的。
如果使用NAT设备，机器的外部IP地址是相同的，但NAT设备的内部端口映射仍然允许它们使用相同的端口号。