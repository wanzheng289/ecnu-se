## 0
用来确定多路访问信道的下一个使用者的协议属于数据链路层的MAC子层
MAC子层：负责决定谁在多路访问链路上下一个发送，是链路层的重要组成部分，尤其对局域网LANs而言
## 4.1 信道分配问题
### 4.1.1 静态信道分配
1.静态分配：对于一个固定的信道，由N个用户共享，用FDM、TDM、CDMA等方式来划分带宽，但对突发性极强的计算机数据流量非常不适合：大多数信道在大多数时间里都是空闲的，当峰值流量/平均流量=1000：1时，性能会严重受影响。
2.试图解决静态分配问题的动态分配：谁需要用信道，谁临时获得信道
### 4.1.2 动态信道分配的假设
1.流量独立
2.单信道
3.冲突可观察
4.时间连续或分槽
5.载波侦听或不听

## 4.2 多路访问协议
### <span style="background:rgba(240, 200, 0, 0.2)">4.2.1 ALOHA</span>
==想说就说==
#### 一、纯ALOHA：时间是连续的
1.原理：只要用户有需要就发送数据；如果帧被损坏了，则发送方要等待一段随机时间，然后再次发送该帧。
2.帧的发送情况：[[ch04.pdf#page=12&selection=10,0,10,68|ch04, p.12]]
传输之前不侦听，如果两个帧重叠→彻底损坏，全部重传
3.冲突危险周期：
①帧时T=帧长/比特速率
②冲突危险周期=2T
当其他用户在两倍于帧时的冲突危险周期内传输时，就会发生冲突。
③如果让所有发送者只在时隙起点发送，就可以减少冲突。
<font color="#76923c">e.g.纯ALOHA网络在200kbps的共享信道上传输200位帧。使这个帧无碰撞的要求是什么</font>
$T=\frac{L}{B}=\frac{200}{200*10^3}=10^{-3}s$
$冲突危险周期=2*10^{-3}s$
在该站点开始发送<font color="#c00000">之前</font>的1ms内不能有任何其他站点开始发送，在该站台发送的<font color="#c00000">这1ms</font> 时间内也不能有任何其他站点开始发送。
4.最大吞吐率
$G$：系统尝试发送的帧数
$P_0$：尝试中成功的比例
吞吐量$S=G*P_0$
$\because 每个T有G次发送尝试$
$\therefore 2T内有2G次发送尝试$
$\because Pr[k]=\frac{G^{k}e^{-G}}{k!}：在长度为2T的冲突窗口中有k次发送尝试的概率$
![[Pasted image 20260105231230.png]]
$\therefore P_0=\frac{2G^{k}e^{-2G}}{k!}=e^{-2G}$
$\therefore S=G*e^{-2G}$
$当G=0.5时,S_{max}=\frac{1}{2e}\approx18.4\%$
$G=站点数量*每个站点发送速率*帧时$
<font color="#76923c">e.g.纯ALOHA网络在200kbps的共享信道上传输200位帧,如果系统（所有站一起）每秒产生1000帧/500帧/250帧，吞吐量是多少？</font>
$T=\frac{L}{B}=\frac{200}{200*10^3}=10^{-3}s$
①$G=1000*T=1$
$吞吐率S=G*e^{-2G}=e^{-2}\approx0.135$
$吞吐量=1000*S=135帧$
②$G=500*T=0.5$
$吞吐率S=G*e^{-2G}=0.5e^{-1}\approx0.184$
$吞吐量=500*S=92帧$
③$G=250*T=0.25$
$吞吐率S=G*e^{-2G}=0.25e^{-0.5}\approx0.152$
$吞吐量=250*S=38帧$
#### 二、分槽ALOHA：时间分成离散的槽，所有帧都必须同步到时间槽中
1.原理：将时间分为以一个帧时为单位的离散的时间片，每个时间片可以用来发送一个帧。站点有数据发送时，必须等到时间片的开始才能发送，所以需要实现时间同步。
2.效率=纯ALOHA的2倍，且能承受更大的负载，但负载过大会导致吞吐率下降[[ch04.pdf#page=20&selection=10,0,10,51|ch04, p.20]]
$冲突危险周期=T$
$Pr[k]=\frac{G^{k}e^{-G}}{k!}：在一个时间槽T内恰好有k次尝试的概率$
![[Pasted image 20260105231300.png]]
$P_0=e^{-G}$
$S=Ge^{-G}$
$G=1时,S_{max}=\frac{1}{e}$
<font color="#76923c">e.g.对具有无限数量用户的分槽ALOHA通道的测量表明，20%的槽是空闲的。</font>
<font color="#76923c">a)信道负载G是多少？</font>
空闲槽→没有用户尝试→k=0
$P_{0}=Pr[一个时隙内k=0个站发送]=空时隙出现的概率=e^{-G}=0.2$
$G=-lnP_0=-ln0.2=1.6$
平均每个时隙有1.6次发送尝试
<font color="#76923c">b)吞吐量是多少？</font>
$S=G*e^{-G}=G*0.2=1.6*0.2=0.32$
每个时隙中，平均0.32个帧被成功传输
<font color="#76923c">c)通道是负载过低还是过载？</font>
$G=1.6>1$→过载
### <span style="background:rgba(240, 200, 0, 0.2)">4.2.2 载波侦听多路访问（CSMA）协议</span>
==讲前先听==
#### 一、CSMA
相比ALOHA的改进：侦听
发送前先载波侦听，如果信道忙就不发送，如果信道空闲就发送
时空图：[[ch04.pdf#page=23&selection=26,0,26,4|ch04, p.23]]
冲突危险周期=传播时延
CSMA并不能彻底消除碰撞，只能缩小碰撞发生的时间窗口
#### 二、坚持型和非坚持型CSMA
当信道忙时，不同CSMA协议的处理方式不同[[ch04.pdf#page=24&selection=24,0,24,38|ch04, p.24]]
1.1-坚持型载波检测多路访问
①原理：当站发现信道空闲时，传输数据的概率=1（一空闲就发送数据）
当一个站有数据要发送时，它首先监听信道，看看是否有其他人正在发送数据
信道空闲→发送数据
信道忙→等待空闲后发送一帧
发生冲突→随机等待一段时间，然后重新监听信道
②冲突的两种可能情景
（1）信号传播延迟造成的冲突。如第一个站的信号还没到达第二个站，第二个站则会认为信道空闲，会立即发送数据
（2）多个站点同时监听到信道空闲，同时发送
2.非坚持型CSMA
当一个站有数据要发送时，它首先监听信道
信道空闲→发送数据
信道忙→随机等待一段时间，然后再次侦听
比1-坚持型载波检测多路访问信道利用率更高&&时延更长
3.p-坚持型CSMA
①原理：当一个站有数据要发送时，它首先监听信道
信道空闲→传输数据的概率=p，等待一个时隙再试的概率=1-p，一直重复到本站成功发送or信道变忙
多个站同时发送→碰撞→退避再重试
②p：降低1-persistent CSMA中多个站点同时发送而造成冲突的概率，克服non-persistent CSMA中造成的时间延迟
③应用于分槽信道
④改进版：IEEE 802.11（WiFi）
4.流程图[[ch04.pdf#page=28&selection=8,0,10,7|ch04, p.28]]
5.吞吐量和负载的关系[[ch04.pdf#page=29&selection=8,0,8,33|ch04, p.29]]
CSMA的性能整体优于ALOHA；在高负载下，越不坚持越好
6.CSMA的缺点：先听后发机制在发送过程中如果发生冲突，仍要将剩余的无效数据发送完，浪费时间和带宽
#### <span style="background:rgba(240, 200, 0, 0.2)">三、带冲突检测的CSMA（CSMA/CD）</span>
==讲前先听+边讲边听==
1.改进：检测&&中止冲突
①冲突检测：站点在发送过程中持续监听信道，通过检测回复信号的能量或者脉冲宽度并将之与发送的信号做比较，如果信号不同，就可以判断发生冲突
②中止：发现冲突则停止发送
2.工作原理：
①发送前监听信道，若闲则发送数据；若忙则一直监听信道直至空闲，开始发送数据
②发送数据时边发送边监听信道，若未检测到冲突，则发送完成。一旦检测到冲突，立即停止发送数据，发送一串阻塞信号，并等待一随机时间后再重新尝试发送。
3.CSMA/CD是经典共享式以太网的基础机制[[ch04.pdf#page=31&selection=8,0,8,33|ch04, p.31]]
信道在不同时刻的工作周期：传输周期；竞争周期；空闲周期
①传输周期：某一个站点成功占用了信道，正在独占式发送一个完整的数据帧
②竞争周期：刚刚一个帧发送完毕，多个站点都有数据要发
③空闲周期：当前一段时间内没有任何站点要发送
4.流程图：BER算法[[ch04.pdf#page=34&selection=8,0,8,24|ch04, p.34]] 
5.CSMA/CD的最小帧长
①原因：冲突危险周期[[ch04.pdf#page=32&selection=8,0,8,38|ch04, p.32]] [[ch04.pdf#page=33&selection=8,0,8,33|ch04, p.33]]
A和C几乎同时开始发送，第一个比特在链路中间发生碰撞，最远端的发送方必须在还没发完帧之前检测到这次碰撞，否则发送方可能已经发完并以为成功了，却根本没意识到发生过碰撞，也就不会重传数据，导致数据丢失
②一帧的最小发送时间 $T≥信号在链路中的往返传播时间=2*传播时间$
$\therefore \frac{L}{B}\geq 2*\frac{D}{V}$
$\therefore 最小帧长L\geq \frac{2*B*D}{V}$
$L$：数据包长度
$B$：信道带宽
$D$：两站之间最远物理距离
$V$：信号在介质中的传播速度
<font color="#76923c">e.g.带宽B=10Mbps，单向最大传播延迟时间=25.6μs，问帧的最小长度？</font>
$L\geq \frac{2*B*D}{V}=2*10^{7}*25.6*10^{-6}=512bits=64bytes$
【单位换算】
$1ms=10^{-3}s$
$1μs=10^{-6}s$
$1ns=10^{-9}s$

### 4.2.3 无冲突协议
==预约→从机制上彻底避免碰撞==
#### 一、位图协议
1.方法：基本位图法
2.原理
①前提：发送方必须知道何时轮到他们发送基本位图协议
②预约：如果发送方有数据，则在争用槽中设置位
有数据→在第i个比特写1
没数据→写0
③发送者按编号顺序依次发送，只要位图中是1就轮到该站点发送一个完整数据帧；每个站点都知道谁有数据
3.信道利用率：$U=\frac{T_{data}}{T_{total}}=\frac{数据帧长度}{位图帧长度+数据帧长度}=\frac{kL}{N+kL}$
假设一共有N个站点，所以位图阶段有N个竞争比特, 每个竞争比特时间为1个bit-time（记为1），每个数据帧长度为L bit，所以发送1帧需要L个bit-time；再设这一轮中，真正有数据要发的站点有k个（0≤k≤N），那么：
预约阶段（位图）：不管有多少站点要发，都要发完N个比特，开销时间=N
发送阶段（数据帧）：有k个站点依次各发1帧，有用时间=kL
[[ch04.pdf#page=38&selection=8,0,8,18|ch04, p.38]]
最低：$\frac{L}{8+L}$
最高：$所有站点都有数据要发,k=N,U=\frac{NL}{N+NL}=\frac{8L}{8+8L}=\frac{L}{1+L}$
$[\frac{L}{N+L},\frac{L}{1+L}]$
4.优点：完全避免冲突
#### 二、令牌传输
站点在逻辑上按一个固定顺序排列成一个环（不一定真的物理环），每个站点都有前继（逻辑顺序中排在它前面的站点）和后继（逻辑顺序中排在它后面的站点）；令牌沿环传递的顺序=发送顺序，拿到令牌的站点可以先发送一帧（或多帧）再交出令牌。
#### 三、二进制倒计数
假设最多有N个站点，每个站点的地址为$log_2N$位。每个站点逐位发送自己的地址，信道对同一时刻发送的比特做或运算，对任意某一位，如果某站点发送0，但它在信道上看到了1，说明至少有一个优先级更高的站点在发送1，自己已经输了竞争，必须立刻退出本轮竞争。能从头到尾在每一位上都没有被1压制的站点获得发送数据帧的权利。

>每个站点将自己的 ID 一位一位广播到信道上。如果某位上自己发了 0，却看到有人发 1，就说明优先级不如别人 → 立即退出。最后，从高位到低位都没有被淘汰的站点就是赢家

![[Pasted image 20260105233351.png]]
e.g.[[ch04.pdf#page=40&selection=8,0,8,16|ch04, p.40]]
### 4.2.4 有限竞争协议
==低负载时用竞争，高负载时用无冲突==
1.优点：结合了随机接入协议和无冲突协议的优点
2.原理
低负载时，使用竞争来提供低时延
高负载时，使用无冲突技术来提供高信道利用率
3.有限竞争协议往往是非对称的
4.核心思想：不要让所有站点一次性同时竞争，而是先把站点划分成很多小组，保证每一组里同时想发送的站点很少，从而避免由于空闲和冲突造成的浪费[[ch04.pdf#page=42&selection=8,0,8,37|ch04, p.42]]
#### 自适应树遍历协议[[ch04.pdf#page=43&selection=8,0,8,31|ch04, p.43]]
e.g.[[ch04.pdf#page=44&selection=188,0,190,7|ch04, p.44]]
用一棵二叉树把所有站点分组，当某一组发生冲突时，就只在该组的子组中继续深度优先搜索，直到每次只剩1个站点成功发送。
当前准备发送的站点数为q，第i层期望的竞争站点数=$q*\frac{1}{2^i}$
$\because 希望每一次轮询中，只有1个站点准备发送$
$\therefore q*\frac{1}{2^i}=1$
$\therefore i=log_2q,即起始搜索层=log_2(当前活跃站点数q)$
e.g.如果只有1个站点要发，q=1，i=0，即从根节点开始轮询
e.g.
Level0：1包含站点A-H
Level1：2包含站点A-D，3包含站点E-H
Level2：4包含站点AB，5包含站点CD，6包含站点EF，7包含站点GH
每个叶子节点是一个具体站点
①A和G请求发送
q=2，i=1
Slot0：轮询level0的根节点1，包含A-H，A和G同时发送会冲突
Slot1：
（1）轮询level1左子树：只有A在该组中要发→A发送成功
（2）轮询level1右子树：只有G在该组中要发→G发送成功
②A和C请求发送
Slot0：轮询level0的根节点1，包含A-H，A和C同时发送会冲突
Slot1：轮询level1的左子树，包含A-D，A和C同时发送会冲突
Slot2：轮询level2的左子树，只有A在该组中要发→A发送成功
Slot3：轮询level2的右子树，只有C在该组中要发→C发送成功
③C和D请求发送
Slot0：轮询level0的根节点1，包含A-H，C和D同时发送会冲突
Slot1：轮询level1的左子树，包含A-D，C和D同时发送会冲突
Slot2：轮询level2的左子树，没有站点请求发送→空闲
Slot3：轮询level2的右子树，包含C-D，C和D同时发送会冲突
Slot4：轮询叶子C，只有C→C发送成功
Slot5：轮询叶子D，只有D→D发送成功
### 4.2.5 无线LAN协议
无线网络相比有线网络更复杂，不同节点覆盖范围不同→隐藏终端&暴露终端；无线节点不能像有线一样检测冲突，导致冲突代价高，需要避免。
1.隐藏站点&暴露站点
①隐藏站点问题：发送者无法感知对方，但仍会在目标接收者处发生冲突
e.g.A在给B发，C也在给B发，但A听不到C，C也听不到A，所以A和C都检测到信道空闲，同时发送，导致在B处发生接收冲突
②暴露站点问题：发送者能感知到对方,但其实仍然可以安全同时发送给不同的接收者
e.g.B在给A发，C想给D发，B的信号能被C听到，C误以为信道忙，于是不敢发，但实际上B→A和C→D互不干扰，C完全可以安全发送
2.解决隐藏终端问题：MACA协议
①原理[[ch04.pdf#page=47&selection=8,0,8,31|ch04, p.47]]：发送站点发送请求短帧（RTS）触发接收站点发送应答短帧（CTS），使接收站点周围的站点监听到CTS帧，在一定时间内避免发送数据。
（1）A向B发送RTS（Request To Send）帧，A周围的站点在一定时间内不发送数据， 以保证CTS帧返回给A
（2）B向A回答CTS（Clear To Send）帧，B周围的站点在一定时间内不发送数据，以保证A发送完数据
（3）A开始发送，若发生冲突(两站点同时发送RTS)，则等待随机时间，再重试。
②未采用载波侦听机制。
## 4.3 以太网
以太网是第一种被大规模实际部署的局域网技术，比令牌环（Token LAN）和ATM更简单、更便宜，在速率竞争中从未掉队
### 4.3.1 经典以太网物理层
1.所有主机共享一根同轴电缆
2.速率最高10Mbps，使用曼彻斯特编码
3.主机运行经典以太网协议来进行信道接入
4.经典以太网结构：[[ch04.pdf#page=52&selection=10,0,10,32|ch04, p.52]]同轴电缆+收发器+接口线
5.实现方式[[ch04.pdf#page=53&selection=8,0,8,33|ch04, p.53]]
总线+同轴电缆or星形+集线器
①10Base5
10：速率=10Mbps
Base：基带传输
5：最大段长的近似值
介质：粗同轴电缆
介质长度：500m
结构：总线型拓扑
终端电阻 ── 粗同轴主干 ── 终端电阻
                  │
             收发器 (Tap)
                  │
               主机
②10Base2
介质：细同轴电缆
介质长度：185m
结构：总线型拓扑
终端电阻 ── 细同轴 ── T接头 ── 主机
                      ├─ T接头 ── 主机
终端电阻 ─────────────┘
③10Base-T
介质：两对双绞线
介质长度：100m
T：双绞线
结构：星型拓扑
中央设备：10Base-T Hub（集线器）
每台主机用两对UTP双绞线（发送一对+接收一对），单独一条线连到Hub
PC ──┐
PC ──┤
PC ──┼── Hub ──→ 物理中心
PC ──┤
PC ──┘
④10Base-F
介质：双光纤
介质长度：2000m
F：光纤
结构：星型拓扑
中央仍是Hub，每台主机通过两根光纤（发送一根+接收一根）连接到10Base-F Hub
### 4.3.2 经典以太网MAC子层协议
1.经典以太网的帧格式[[ch04.pdf#page=56&selection=8,0,10,13|ch04, p.56]]
①Ethernet(DIX）
前导码（8bytes）→目的地址（6bytes）→源地址（6bytes）→上层协议类型（2bytes）→数据（0-1500bytes）→填充（0-46bytes）→校验和（4bytes）
②IEEE 802.3.
前导码+SoF（8bytes）→目的地址（6bytes）→源地址（6bytes）→数据长度（2bytes）→数据（0-1500bytes）→填充（0-46bytes）→校验和（4bytes）
2.工作机制[[ch04.pdf#page=57&selection=8,0,8,38|ch04, p.57]]
①经典以太网的MAC协议是1-persistent CSMA/CD
②二进制指数退避BEB：冲突后的随机退避，第k次冲突在第0-$2^{k}-1$个时隙中随机等
③冲突检测最坏需要2τ时间
（1）τ=信号从以太网一端传播到另一端的最大单程传播时延
（2）是以太网最小帧长度存在的物理原因
④流程图[[ch04.pdf#page=58&selection=8,0,8,36|ch04, p.58]]
3.经典以太网地址
①以太网的每个站点都有一块网卡NIC，为站点提供链路层地址
②以太网地址是6byte=48bit，用16进制+冒号分隔
e.g.4A:30:10:21:10:1A

|字节|十六进制|
|---|---|
|1|4A|
|2|30|
|3|10|
|4|21|
|5|10|
|6|1A|
③查看MAC地址的命令：`ipconfig /all`
④单播地址&组播地址
（1）单播地址：第一个字节的最后一个比特=0
（2）组播地址：第一个字节的最后一个比特=1
（3）广播地址：48位全为F
e.g.
4A:30:10:21:10:1A-$(4A)_{16}=(01001010)_2$，最后一个比特=0，是单播地址
47:20:1B:2E:08:EE-$(47)_{16}=(01000111)_2$，最后一个比特=1，是多播地址
FF:FF:FF:FF:FF:FF-广播地址
### 4.3.3 以太网性能
经典10Mbps以太网在不同帧长和不同发送站点数量下的信道效率：[[ch04.pdf#page=62&selection=8,0,8,20|ch04, p.62]]
帧长越大，效率越高
### 4.3.4 交换式以太网
1.带宽共享：经典共享式以太网中，两台主机共享10Mbps带宽，但不是每台都5Mbps，而是轮流占用10Mbps，交替发送，2个主机的平均带宽是5Mbps
2.冲突域：所有共享同一物理信道、可能发生冲突的一组设备的集合
①没有桥/交换机时：整个网络只有1个冲突域
②有桥：自己形成一个独立的冲突域，域内可能发生冲突，但不同域之间不会发生冲突
桥的作用就是分割冲突域
3.全双工交换式以太网[[ch04.pdf#page=65&selection=8,0,8,30|ch04, p.65]]
中间是交换机，每台主机独占一个交换机端口，每个端口都是一个独立的冲突域
全双工：每一台主机与交换机之间同时存在发送和接收，方向是同时双向的
4.集线器和交换机[[ch04.pdf#page=66&selection=8,0,8,26|ch04, p.66]]
①集线器：把所有线路接入到同一个CSMA/CD冲突域，负责<font color="#c00000">汇聚</font>来自多台计算机的流量
②交换机：把每个端口<font color="#c00000">隔离</font>成一个独立冲突域，多端口吞吐量大得多，全双工线不再需要CSMA/CD
交换机可以连接：计算机、Hub、以及其他交换机
### 4.3.5 快速以太网
1.将带宽10MBps提升到100Mbps，但MAC子层没有改变
2.把网络最大长度缩短为原来的1/10→保持最小帧长
3.主要使用双绞线
4.100Mbps在不同物理介质上的三种实现方式

| 标准         | 传输介质 | 单段最大长度 | 主要特点              |
| ---------- | ---- | ------ | ----------------- |
| 100Base-T4 | 双绞线  | 100m   | 使用Cat3线           |
| 100Base-TX | 双绞线  | 100m   | 100 Mbps 全双工+Cat5 |
| 100Base-FX | 光纤   | 2000m  | 100 Mbps 全双工+远距离  |
5.编码方式[[ch04.pdf#page=69&selection=8,0,8,26|ch04, p.69]]
e.g.曼彻斯特编码：带宽=10Mbps；波特率=20Mbps
### 4.3.6 千兆以太网
速率=1Gbps=1000Mbps
1.千兆以太网的配置：全双工，点对点链路/多站以太网[[ch04.pdf#page=70&selection=8,0,8,16|ch04, p.70]]
2.以太网的MAC地址长度、帧格式、最大帧长、最小帧长不变；因为速度提升，所以MAC子层需要改变
2.千兆以太网的介质访问方式
①半双工模式：集线器+CSMA/CD；最大长度比经典以太网小100倍（2500m→25m）
②全双工模式（正常模式）：交换机+交换机缓存，没有竞争，没有
3.特性→增加网络半径到200m[[ch04.pdf#page=72&selection=36,0,40,16|ch04, p.72]]
①载波扩充：强制在硬件层面把64B的最小帧拖长为512B（填充比特）
②帧突发：允许发送者在一次传输中把多个短帧打包成一个连续突发发送
4.实现方式[[ch04.pdf#page=73&selection=8,0,8,32|ch04, p.73]]
最常见：双绞线
5.编码[[ch04.pdf#page=74&selection=8,0,8,28|ch04, p.74]]
### 4.3.7 万兆以太网
1.万兆以太网线缆[[ch04.pdf#page=75&selection=8,0,8,19|ch04, p.75]]
### 4.3.8 40Gb/s和100Gb/s以太网

### 4.3.9 以太网回顾

## 4.4 无线LAN
### 4.4.1 IEEE 802.11体系结构和协议栈
1.体系结构[[ch04.pdf#page=78&selection=8,0,10,14|ch04, p.78]]
①基础设施模式：所有终端必须通过无线接入点通信，无线接入点再通过有线网络连接到更大的网络
②自组织模式：点对点
2.协议栈[[ch04.pdf#page=79&selection=8,0,10,14|ch04, p.79]]
3.服务集
①基本服务集：一组在同一无线信道上、彼此能直接通信的无线站点集合
（1）基础设施模式服务集：终端通信需经由AP转发
（2）自组织模式服务集：终端两两直接通信
②扩展服务集：由多个BSS通过分布式系统互联而成的一个逻辑无线局域网
### 4.4.2 IEEE 802.11 物理层
1.NIC支持多个标准[[ch04.pdf#page=81&selection=13,0,13,21|ch04, p.81]]

### 4.4.3 IEEE 802.11 MAC子层协议
1.CSMA/CA
①流程图[[ch04.pdf#page=82&selection=8,0,8,24|ch04, p.82]]
K：当前重传次数
$T_B$：退避时间
IFS：帧间间隔
RTS：请求发送
CTS：允许发送
（1）CSMA/CD：节点侦听到信道空闲时立即发送
（2）CSMA/CA：节点推迟发送，每新尝试一次都要随机回退，避免有多个站同时等待信道空闲并发现信道空闲后立即发送而导致的冲突
②利用CSMA/CA机制发送帧的时间序列[[ch04.pdf#page=83&selection=8,0,8,41|ch04, p.83]]
CSMA/CA通过<font color="#c00000">插入随机退避时间</font>来避免冲突，无线MAC层用ACK+重传来应对无线误码和丢包
③隐藏终端和暴露终端[[ch04.pdf#page=84&selection=10,0,10,66|ch04, p.84]]
（1）隐藏终端问题：A想向B发送，但是监测不到B正忙
（2）暴露终端问题：B想向C发送，但是误认为传输会失败
④使用CSMA/CA的虚拟信道侦听[[ch04.pdf#page=85&selection=8,0,8,41|ch04, p.85]]
802.11通过网络分配向量NAV和RTS/CTS来实现虚拟信道侦听，让所有站点提前知道信道将被占用，从而避免隐藏终端冲突
2.IEEE 802.11中的5个帧间间隔IFS[[ch04.pdf#page=86&selection=8,0,8,41|ch04, p.86]]
通过不同退避时间实现服务质量区分，间隔越短优先级越高。MAC层还有省电等机制。
为了尽量避免碰撞，802.11规定，所有的站在完成发送后，必须再等待一段很短的时间（继续监听）才能发送下一帧。这段时间的通称是帧间间隔IFS。帧间间隔的长短取决于该站要发送的帧的类型。高优先级的帧需要等待的时间较短，因此可以优先获得发送权，但低优先级帧就必须等待较长的时间。
①SIFS：短帧间间隔，用来间隔需要立即响应的帧，如控制帧(RTS/CTS/ACK)等 ②AIFS：任意帧间间隔。根据访问类别(即要传输的数据类型)对站点进行优先级排序，AISF的计算公式为：AISF编号×时隙+ SISF
③DIFS：分布协调功能帧间间隔，只能够由工作于DCF模式的站点来使用
④PIFS：集中协调功能帧间间隔，只能够由工作于PCF模式的站点来使用
⑤EIFS: 在前一帧出错的情况下，发送节点不得不延迟 EIFS 而不是DIFS时间段，再发送下一帧
### 4.4.4 IEEE 802.11 帧结构
1.数据帧格式[[ch04.pdf#page=88&selection=8,0,8,26|ch04, p.88]]

| 字段                   | 长度(字节) | 作用             |
| -------------------- | ------ | -------------- |
| Frame Control        | 2      | 帧的“身份证”，说明帧类型  |
| Duration             | 2      | 信道占用时间（用于 NAV） |
| Address 1            | 6      | 接收方            |
| Address 2            | 6      | 发送方            |
| Address 3            | 6      | AP 或最终目的       |
| Sequence             | 2      | 序号，防止重复        |
| Data                 | 0–2312 | 真实数据           |
| FCS (Check sequence) | 4      | CRC 校验         |
Frame Control：2bytes=16bits
```
Version | Type | Subtype | ToDS | FromDS | MoreFrag | Retry | Power | MoreData | Protected | Order
```

| 子字段（Field）            | 含义说明（Explanation）        | 实际作用                         |
| --------------------- | ------------------------ | ---------------------------- |
| Version               | 当前版本为 0                  | 802.11 协议版本号，预留给未来升级         |
| Type                  | 帧类型：管理(00)、控制(01)、数据(10) | 决定这是“管理帧 / 控制帧 / 数据帧”        |
| Subtype               | 各类型的具体子类型                | 例如：RTS、CTS、ACK、Beacon、Data 等 |
| To DS                 | 是否发往分布系统                 | 1 表示发往 AP；0 表示不经过 AP         |
| From DS               | 是否来自分布系统                 | 1 表示由 AP 发出；0 表示非 AP 发出      |
| More flag (More Frag) | 为 1 表示后面还有分片             | 大帧被拆分时用于标识“是否还有后续分片”         |
| Retry                 | 为 1 表示该帧为重传帧             | 防止接收端重复接收同一数据                |
| Pwr mgt               | 为 1 表示终端处于省电模式           | 终端省电，AP 代为缓存未取数据             |
| More data             | 为 1 表示发送方还有数据待发送         | 告诉对方“别睡，我还有数据没发完”            |
| WEP / Protected       | 为 1 表示已加密                | 指示该帧是否被加密（WEP/WPA/WPA2/WPA3） |
| Rsvd (Reserved)       | 保留字段                     | 预留给将来协议扩展使用                  |
2.地址字段的使用机制[[ch04.pdf#page=90&selection=8,0,8,20|ch04, p.90]]
DS：分发系统，指多个AP之间连接的有线或无线基础设施，用于在不同BSS（基本服务集）之间转发帧
MAC帧头中有两个控制位字段：
- `To DS`：该帧是否是要发送到分发系统
- `From DS`：该帧是否是来自于分发系统

| To DS<br>是否要发送到分发系统 | From DS<br>是否是来自于分发系统 | Address 1<br>接收者 | Address 2<br>发送者 | Address 3<br>目的地 | Address 4<br>源地址 |
| ------------------- | --------------------- | ---------------- | ---------------- | ---------------- | ---------------- |
| 0                   | 0                     | 目的站（Destination） | 源站（Source）       | BSS ID           | 不用               |
| 0                   | 1                     | 目的站              | 发送 AP            | 源站               | 不用               |
| 1                   | 0                     | 接收 AP            | 源站               | 目的站              | 不用               |
| 1                   | 1                     | 接收 AP            | 发送 AP            | 目的站              | 源站               |
- 00：站点 A 和 B 在同一个AP下，在同一个BSS内通信，不通过分发系统
- 01：AP 把数据从 DS 发给 STA
- 10：站点 B 向另一个 BSS 中的 A 发数据，首先发送到自己BSS中的 AP
- 11：一个 AP 通过 无线分发系统将帧转发到另一个 AP
①IBSS，自组网

|地址字段|存的是什么|
|---|---|
|Address 1|B（目的）|
|Address 2|A（源）|
|Address 3|BSS ID|
|Address 4|不用|
②有线网→AP→终端

| 地址字段      | 存的是什么 |
| --------- | ----- |
| Address 1 | B（目的） |
| Address 2 | 发送AP  |
| Address 3 | A（源）  |
| Address 4 | 不用    |
③终端→AP→有线网

| 地址字段      | 存的是什么 |
| --------- | ----- |
| Address 1 | 接收AP  |
| Address 2 | A（源）  |
| Address 3 | B（目的） |
| Address 4 | 不用    |
④AP↔AP

| 地址字段      | 存的是什么 |
| --------- | ----- |
| Address 1 | 接收AP  |
| Address 2 | 发送AP  |
| Address 3 | B（目的） |
| Address 4 | A（源）  |

### 4.4.5 服务
1.关联与数据传输服务
2.安全与隐私服务
3.业务优先级与功耗控制服务
## 4.5 蓝牙
jump

## 4.6 DOCSIS
jump

## 4.7 数据链路层交换
### 4.7.1 网桥的使用

### 4.7.2 学习网桥
1.拓扑结构：桥接器的工作方式等价于一个交换式局域网设备，而不是集线器；桥接器的每个端口可以接：普通主机（电脑）、其他桥、集线器
2.原理：通过逆向学习法决定从哪个端口转发帧
①将帧的源MAC地址和进入桥的端口号进行绑定，写入转发表
②如果目的MAC地址已经在表中学过，就只从对应端口转发
③如果目的地址还没学到，就进行泛洪——向除入口端口外的所有端口广播
3.优点：不需要人工配置
①转发表中的每条MAC记录都有老化时间，一段时间没通信就会自动删除
②对双向通信特别省带宽
4.网桥处理过程的协议栈
①桥是链路层的扩展设备，不是网络层设备
②桥使用以太网帧头里的MAC地址转发，但不会删除或修改以太网头
③桥不查看网络层首部
### 4.7.3 生成树网桥
1.当桥接网络中存在冗余链路（环路）时，只靠学习型桥会导致帧无限循环的严重问题，因此必须使用生成树协议来消除环路
2.运行后的最终结果
①B1被选为根桥，两条虚线的链路被关闭
②B4到根桥B1有两条可能路径：经B2→B1/经B3→B1，两条路径到B1的距离都是1；<font color="#c00000">当路径代价相同时，选Bridge ID更小的邻居</font>，所以B2的ID<B3，B4 选择连向B2的那条链路作为根端口，另一条到B3的链路被阻塞
③B5到B1有两条路径：经B3→B1距离=1/经B4→B2→B1距离=2；<font color="#c00000">优先选择路径代价更小的</font>，所以B5选择B3方向，到B4的那条链路被阻塞
### 4.7.4 中继器、集线器、网桥、交换机、路由器和网关
1.不同设备对应的OSI层次

|OSI 层|层名|对应设备|它能“看懂”的信息|
|---|---|---|---|
|第7层|应用层|Application Gateway（应用网关）|HTTP、FTP、SMTP 等应用协议|
|第4层|传输层|Transport Gateway（传输网关）|TCP/UDP 端口号|
|第3层|网络层|**Router（路由器）**|IP 地址|
|第2层|数据链路层|**Bridge（桥）、Switch（交换机）**|MAC 地址、以太网帧|
|第1层|物理层|**Repeater（中继器）、Hub（集线器）**|仅比特信号（0/1 电信号）|
2.分组封装
帧=帧头+分组+CRC  
分组=IP首部+TCP首部+用户数据
分组由网络层生成，帧由数据链路层生成
### 4.7.5 虚拟LAN
1.没有VLAN的传统集中布线局域网[[ch04.pdf#page=111&selection=8,0,8,21|ch04, p.111]]
2.原理：VLAN把一个物理LAN拆分成多个逻辑LAN，方便管理；交换机端口会按照VLAN被着色
#### IEEE 802.1q标准
1.网桥/交换机必须识别VLAN才能支持VLAN
2.在802.1Q中，以太网帧会被打上颜色标签
3.不支持VLAN的老交换机也能共存[[ch04.pdf#page=113&selection=8,0,8,33|ch04, p.113]]
4.帧格式[[ch04.pdf#page=114&selection=8,0,8,33|ch04, p.114]]
①802.3传统以太网帧

|字段|作用|
|---|---|
|Destination address|目标 MAC 地址|
|Source address|源 MAC 地址|
|Length|数据长度|
|Data|上层数据|
|Pad|填充到最小帧长|
|Checksum (FCS)|CRC 校验|
②802.1Q带VLAN标签的以太网帧：多了VLAN协议ID和Tag字段